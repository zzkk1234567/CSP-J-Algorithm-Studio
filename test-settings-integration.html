<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¾ç½®é›†æˆæµ‹è¯•</title>
    <link href="https://cdn.tailwindcss.com" rel="stylesheet">
    <style>
        .test-result {
            padding: 1rem;
            margin: 0.5rem 0;
            border-radius: 0.5rem;
            font-family: monospace;
        }
        .test-pass {
            background-color: #d1fae5;
            border: 2px solid #10b981;
            color: #065f46;
        }
        .test-fail {
            background-color: #fee2e2;
            border: 2px solid #ef4444;
            color: #991b1b;
        }
    </style>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-lg p-6">
        <h1 class="text-3xl font-bold mb-6">âš™ï¸ è®¾ç½®é›†æˆæµ‹è¯•</h1>
        
        <div id="test-results"></div>
        
        <div class="mt-6">
            <h2 class="text-xl font-bold mb-4">æ‰‹åŠ¨æµ‹è¯•</h2>
            <div class="space-y-4">
                <div>
                    <button onclick="testOpenSettings()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                        æµ‹è¯•æ‰“å¼€è®¾ç½®é¢æ¿
                    </button>
                </div>
                <div>
                    <button onclick="testThemeSwitch()" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">
                        æµ‹è¯•ä¸»é¢˜åˆ‡æ¢
                    </button>
                </div>
                <div>
                    <button onclick="testSpeedChange()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                        æµ‹è¯•é€Ÿåº¦è°ƒæ•´
                    </button>
                </div>
                <div>
                    <button onclick="testConfigPersistence()" class="bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600">
                        æµ‹è¯•é…ç½®æŒä¹…åŒ–
                    </button>
                </div>
            </div>
        </div>
        
        <div class="mt-6 p-4 bg-gray-50 rounded">
            <h3 class="font-bold mb-2">å½“å‰é…ç½®:</h3>
            <pre id="current-config" class="text-sm"></pre>
        </div>
    </div>

    <!-- é…ç½®ç®¡ç†ç³»ç»Ÿ -->
    <script src="utils/ConfigManager.js"></script>

    <script>
        const results = [];
        
        function addResult(testName, passed, message) {
            results.push({ testName, passed, message });
            displayResults();
        }
        
        function displayResults() {
            const container = document.getElementById('test-results');
            container.innerHTML = results.map(r => `
                <div class="test-result ${r.passed ? 'test-pass' : 'test-fail'}">
                    <strong>${r.passed ? 'âœ…' : 'âŒ'} ${r.testName}</strong><br>
                    ${r.message}
                </div>
            `).join('');
        }
        
        function displayCurrentConfig() {
            const config = window.configManager.getAll();
            document.getElementById('current-config').textContent = JSON.stringify(config, null, 2);
        }
        
        // è‡ªåŠ¨åŒ–æµ‹è¯•
        function runAutomatedTests() {
            console.log('ğŸ§ª å¼€å§‹è¿è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•...');
            
            // æµ‹è¯•1: ConfigManageræ˜¯å¦å·²åˆå§‹åŒ–
            try {
                if (window.configManager) {
                    addResult('ConfigManageråˆå§‹åŒ–', true, 'ConfigManagerå·²æˆåŠŸåˆå§‹åŒ–');
                } else {
                    addResult('ConfigManageråˆå§‹åŒ–', false, 'ConfigManageræœªæ‰¾åˆ°');
                }
            } catch (error) {
                addResult('ConfigManageråˆå§‹åŒ–', false, error.message);
            }
            
            // æµ‹è¯•2: é»˜è®¤é…ç½®æ˜¯å¦æ­£ç¡®
            try {
                const theme = window.configManager.get('theme');
                const speed = window.configManager.get('animationSpeed');
                const language = window.configManager.get('language');
                
                if (theme && speed && language) {
                    addResult('é»˜è®¤é…ç½®åŠ è½½', true, `ä¸»é¢˜: ${theme}, é€Ÿåº¦: ${speed}ms, è¯­è¨€: ${language}`);
                } else {
                    addResult('é»˜è®¤é…ç½®åŠ è½½', false, 'éƒ¨åˆ†é…ç½®é¡¹ç¼ºå¤±');
                }
            } catch (error) {
                addResult('é»˜è®¤é…ç½®åŠ è½½', false, error.message);
            }
            
            // æµ‹è¯•3: é…ç½®è¯»å†™åŠŸèƒ½
            try {
                const testValue = 2000;
                window.configManager.set('animationSpeed', testValue);
                const readValue = window.configManager.get('animationSpeed');
                
                if (readValue === testValue) {
                    addResult('é…ç½®è¯»å†™', true, `æˆåŠŸå†™å…¥å¹¶è¯»å–å€¼: ${testValue}`);
                } else {
                    addResult('é…ç½®è¯»å†™', false, `æœŸæœ› ${testValue}, å®é™… ${readValue}`);
                }
                
                // æ¢å¤é»˜è®¤å€¼
                window.configManager.set('animationSpeed', 1000);
            } catch (error) {
                addResult('é…ç½®è¯»å†™', false, error.message);
            }
            
            // æµ‹è¯•4: é…ç½®ç›‘å¬å™¨
            try {
                let listenerCalled = false;
                window.configManager.onChange((config) => {
                    listenerCalled = true;
                });
                
                window.configManager.set('theme', 'dark');
                
                setTimeout(() => {
                    if (listenerCalled) {
                        addResult('é…ç½®ç›‘å¬å™¨', true, 'ç›‘å¬å™¨æˆåŠŸè§¦å‘');
                    } else {
                        addResult('é…ç½®ç›‘å¬å™¨', false, 'ç›‘å¬å™¨æœªè§¦å‘');
                    }
                    
                    // æ¢å¤é»˜è®¤å€¼
                    window.configManager.set('theme', 'light');
                    displayCurrentConfig();
                }, 100);
            } catch (error) {
                addResult('é…ç½®ç›‘å¬å™¨', false, error.message);
            }
            
            // æµ‹è¯•5: localStorageæŒä¹…åŒ–
            try {
                const savedConfig = localStorage.getItem('cspj-config');
                if (savedConfig) {
                    const parsed = JSON.parse(savedConfig);
                    addResult('é…ç½®æŒä¹…åŒ–', true, `é…ç½®å·²ä¿å­˜åˆ°localStorage (${Object.keys(parsed).length}ä¸ªé…ç½®é¡¹)`);
                } else {
                    addResult('é…ç½®æŒä¹…åŒ–', false, 'localStorageä¸­æœªæ‰¾åˆ°é…ç½®');
                }
            } catch (error) {
                addResult('é…ç½®æŒä¹…åŒ–', false, error.message);
            }
            
            displayCurrentConfig();
        }
        
        // æ‰‹åŠ¨æµ‹è¯•å‡½æ•°
        function testOpenSettings() {
            alert('åœ¨å®é™…é¡µé¢ä¸­ï¼Œè¿™ä¼šæ‰“å¼€è®¾ç½®é¢æ¿ã€‚\nè¯·åœ¨ csp-j-learning-tool.html ä¸­æµ‹è¯•æ­¤åŠŸèƒ½ã€‚');
        }
        
        function testThemeSwitch() {
            const currentTheme = window.configManager.get('theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            window.configManager.set('theme', newTheme);
            alert(`ä¸»é¢˜å·²åˆ‡æ¢ä¸º: ${newTheme}`);
            displayCurrentConfig();
        }
        
        function testSpeedChange() {
            const speeds = [500, 1000, 1500, 2000, 2500, 3000];
            const currentSpeed = window.configManager.get('animationSpeed');
            const currentIndex = speeds.indexOf(currentSpeed);
            const newIndex = (currentIndex + 1) % speeds.length;
            const newSpeed = speeds[newIndex];
            
            window.configManager.set('animationSpeed', newSpeed);
            alert(`åŠ¨ç”»é€Ÿåº¦å·²è°ƒæ•´ä¸º: ${newSpeed}ms`);
            displayCurrentConfig();
        }
        
        function testConfigPersistence() {
            // è®¾ç½®ä¸€äº›æµ‹è¯•å€¼
            window.configManager.set('theme', 'dark');
            window.configManager.set('animationSpeed', 1500);
            window.configManager.set('enableSound', true);
            
            alert('é…ç½®å·²æ›´æ–°ã€‚è¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹é…ç½®æ˜¯å¦æŒä¹…åŒ–ã€‚');
            displayCurrentConfig();
        }
        
        // é¡µé¢åŠ è½½æ—¶è¿è¡Œæµ‹è¯•
        window.addEventListener('DOMContentLoaded', () => {
            setTimeout(runAutomatedTests, 500);
        });
    </script>
</body>
</html>
