                case 'lis':
                    animateLIS();
                    break;
                default:
                    showSimulatedAnimation(algorithm);
            }
        }
        
        // å†’æ³¡æ’åºåŠ¨ç”»
        function animateBubbleSort() {
            const bars = document.querySelectorAll('.array-bar');
            let i = 0;
            
            const animate = () => {
                if (i >= bars.length - 1) {
                    updateDetectiveMessage('å†’æ³¡æ’åºå®Œæˆï¼æœ€å°çš„å…ƒç´ å·²ç»"å†’æ³¡"åˆ°æœ€å‰é¢äº†ï¼ğŸ‰');
                    return;
                }
                
                // é«˜äº®å½“å‰æ¯”è¾ƒçš„å…ƒç´?
                bars[i].style.backgroundColor = '#ef4444'; // red
                bars[i + 1].style.backgroundColor = '#ef4444';
                
                setTimeout(() => {
                    // è·å–æ•°å€¼å¹¶æ¯”è¾ƒ
                    const val1 = parseInt(bars[i].textContent);
                    const val2 = parseInt(bars[i + 1].textContent);
                    
                    if (val1 > val2) {
                        // äº¤æ¢å…ƒç´ 
                        const tempContent = bars[i].textContent;
                        const tempHeight = bars[i].style.height;
                        const tempLineHeight = bars[i].style.lineHeight;
                        
                        bars[i].textContent = bars[i + 1].textContent;
                        bars[i].style.height = bars[i + 1].style.height;
                        bars[i].style.lineHeight = bars[i + 1].style.lineHeight;
                        
                        bars[i + 1].textContent = tempContent;
                        bars[i + 1].style.height = tempHeight;
                        bars[i + 1].style.lineHeight = tempLineHeight;
                    }
                    
                    // æ¢å¤é¢œè‰²
                    bars[i].style.backgroundColor = '#3b82f6'; // blue
                    bars[i + 1].style.backgroundColor = '#3b82f6';
                    
                    i++;
                    if (i < bars.length - 1) {
                        setTimeout(animate, 300);
                    } else {
                        updateDetectiveMessage('å†’æ³¡æ’åºå®Œæˆï¼æœ€å°çš„å…ƒç´ å·²ç»"å†’æ³¡"åˆ°æœ€å‰é¢äº†ï¼ğŸ‰');
                    }
                }, 1000);
            };
            
            animate();
        }
        
        // äºŒåˆ†æŸ¥æ‰¾åŠ¨ç”»
        function animateBinarySearch() {
            const elements = document.querySelectorAll('#algorithm-visualization span');
            let left = 0, right = elements.length - 1;
            let target = 7;
            
            const search = () => {
                if (left > right) {
                    updateDetectiveMessage('äºŒåˆ†æŸ¥æ‰¾å®Œæˆï¼ç›®æ ‡å€¼å·²æ‰¾åˆ°ï¼ğŸ?);
                    return;
                }
                
                const mid = Math.floor((left + right) / 2);
                
                // é‡ç½®æ‰€æœ‰é¢œè‰?
                elements.forEach(el => {
                    el.className = 'px-2 py-1 bg-gray-600 text-white mr-1';
                });
                
                // é«˜äº®å½“å‰èŒƒå›´
                for (let i = left; i <= right; i++) {
                    elements[i].className = 'px-2 py-1 bg-blue-500 text-white mr-1';
                }
                
                // é«˜äº®ä¸­é—´å…ƒç´ 
                elements[mid].className = 'px-2 py-1 bg-yellow-500 text-black mr-1';
                
                setTimeout(() => {
                    const midValue = parseInt(elements[mid].textContent);
                    
                    if (midValue === target) {
                        elements[mid].className = 'px-2 py-1 bg-green-500 text-white mr-1';
                        updateDetectiveMessage('æ‰¾åˆ°ç›®æ ‡å€¼ï¼äºŒåˆ†æŸ¥æ‰¾å®Œæˆï¼ğŸ?);
                    } else if (midValue < target) {
                        left = mid + 1;
                        setTimeout(search, 1000);
                    } else {
                        right = mid - 1;
                        setTimeout(search, 1000);
                    }
                }, 1500);
            };
            
            search();
        }
        
        // DFSåŠ¨ç”»
        function animateDFS() {
            const nodes = document.querySelectorAll('[id^="node-"]');
            const visitOrder = [0, 1, 3, 2]; // èŠ‚ç‚¹è®¿é—®é¡ºåº
            let currentIndex = 0;
            
            const visit = () => {
                if (currentIndex >= visitOrder.length) {
                    updateDetectiveMessage('DFSéå†å®Œæˆï¼æ·±åº¦ä¼˜å…ˆï¼Œä¸€æ¡è·¯èµ°åˆ°åº•ï¼ğŸ”');
                    return;
                }
                
                const nodeIndex = visitOrder[currentIndex];
                nodes[nodeIndex].className = 'bg-green-500 text-white text-center p-2 rounded animate-pulse';
                
                currentIndex++;
                setTimeout(visit, 1000);
            };
            
            visit();
        }
        
        // BFSåŠ¨ç”»
        function animateBFS() {
            const nodes = document.querySelectorAll('[id^="node-"]');
            const visitOrder = [0, 1, 2, 3]; // èŠ‚ç‚¹è®¿é—®é¡ºåº
            let currentIndex = 0;
            
            const visit = () => {
                if (currentIndex >= visitOrder.length) {
                    updateDetectiveMessage('BFSéå†å®Œæˆï¼å¹¿åº¦ä¼˜å…ˆï¼Œå±‚å±‚æ¨è¿›ï¼ğŸŒ?);
                    return;
                }
                
                const nodeIndex = visitOrder[currentIndex];
                nodes[nodeIndex].className = 'bg-orange-500 text-white text-center p-2 rounded animate-bounce';
                
                currentIndex++;
                setTimeout(visit, 800);
            };
            
            visit();
        }
        
        // æ ‘éå†åŠ¨ç”?
        function animateTreeTraversal() {
            const nodes = document.querySelectorAll('#algorithm-visualization .rounded-full');
            const visitOrder = [0, 1, 2]; // A, B, C
            let currentIndex = 0;
            
            const visit = () => {
                if (currentIndex >= visitOrder.length) {
                    updateDetectiveMessage('å‰åºéå†å®Œæˆï¼æ ¹â†’å·¦â†’å³çš„é¡ºåºï¼ğŸŒ³');
                    return;
                }
                
                const nodeIndex = visitOrder[currentIndex];
                nodes[nodeIndex].className = 'bg-green-500 text-white w-8 h-8 rounded-full flex items-center justify-center animate-ping';
                
                currentIndex++;
                setTimeout(visit, 1200);
            };
            
            visit();
        }
        
        // é€šç”¨æ¨¡æ‹ŸåŠ¨ç”»
        // é€‰æ‹©æ’åºåŠ¨ç”»
        function animateSelectionSort() {
            const bars = document.querySelectorAll('.array-bar');
            let i = 0;
            
            const animate = () => {
                if (i >= bars.length) {
                    updateDetectiveMessage('é€‰æ‹©æ’åºå®Œæˆï¼æ¯æ¬¡é€‰æ‹©æœ€å°å€¼æ”¾åˆ°æ­£ç¡®ä½ç½®ï¼ğŸ¯');
                    bars.forEach(bar => bar.style.backgroundColor = '#10b981');
                    return;
                }
                
                // é«˜äº®å½“å‰ä½ç½®
                bars[i].style.backgroundColor = '#f59e0b';
                let minIndex = i;
                let j = i + 1;
                
                const compareStep = () => {
                    if (j >= bars.length) {
                        // æ‰¾åˆ°æœ€å°å€¼ï¼Œè¿›è¡Œäº¤æ¢
                        if (minIndex !== i) {
                            bars[minIndex].style.backgroundColor = '#ef4444';
                            setTimeout(() => {
                                const temp = bars[i].innerHTML;
                                const tempHeight = bars[i].style.height;
                                bars[i].innerHTML = bars[minIndex].innerHTML;
                                bars[i].style.height = bars[minIndex].style.height;
                                bars[i].style.lineHeight = bars[minIndex].style.height;
                                bars[minIndex].innerHTML = temp;
                                bars[minIndex].style.height = tempHeight;
                                bars[minIndex].style.lineHeight = tempHeight;
                                
                                bars[i].style.backgroundColor = '#10b981';
                                bars[minIndex].style.backgroundColor = '#3b82f6';
                                i++;
                                setTimeout(animate, 800);
                            }, 800);
                        } else {
                            bars[i].style.backgroundColor = '#10b981';
                            i++;
                            setTimeout(animate, 500);
                        }
                        return;
                    }
                    
                    bars[j].style.backgroundColor = '#8b5cf6';
                    setTimeout(() => {
                        if (parseInt(bars[j].innerHTML) < parseInt(bars[minIndex].innerHTML)) {
                            if (minIndex !== i) bars[minIndex].style.backgroundColor = '#3b82f6';
                            minIndex = j;
                            bars[j].style.backgroundColor = '#ef4444';
                        } else {
                            bars[j].style.backgroundColor = '#3b82f6';
                        }
                        j++;
                        setTimeout(compareStep, 600);
                    }, 600);
                };
                
                compareStep();
            };
            
            animate();
        }
        
        // æ’å…¥æ’åºåŠ¨ç”»
        function animateInsertionSort() {
            const bars = document.querySelectorAll('.array-bar');
            let i = 1;
            
            // ç¬¬ä¸€ä¸ªå…ƒç´ é»˜è®¤å·²æ’åº
            bars[0].style.backgroundColor = '#10b981';
            
            const animate = () => {
                if (i >= bars.length) {
                    updateDetectiveMessage('æ’å…¥æ’åºå®Œæˆï¼æ¯ä¸ªå…ƒç´ éƒ½æ’å…¥åˆ°äº†æ­£ç¡®çš„ä½ç½®ï¼ğŸ“');
                    return;
                }
                
                const current = parseInt(bars[i].innerHTML);
                bars[i].style.backgroundColor = '#f59e0b';
                
                let j = i - 1;
                const insertStep = () => {
                    if (j < 0 || parseInt(bars[j].innerHTML) <= current) {
                        // æ‰¾åˆ°æ’å…¥ä½ç½®
                        bars[i].style.backgroundColor = '#10b981';
                        i++;
                        setTimeout(animate, 800);
                        return;
                    }
                    
                    bars[j].style.backgroundColor = '#8b5cf6';
                    setTimeout(() => {
                        // å‘å³ç§»åŠ¨å…ƒç´ 
                        bars[j + 1].innerHTML = bars[j].innerHTML;
                        bars[j + 1].style.height = bars[j].style.height;
                        bars[j + 1].style.lineHeight = bars[j].style.height;
                        bars[j].style.backgroundColor = '#3b82f6';
                        j--;
                        setTimeout(insertStep, 600);
                    }, 600);
                };
                
                setTimeout(() => {
                    bars[j + 1].innerHTML = current;
                    bars[j + 1].style.height = current + 'px';
                    bars[j + 1].style.lineHeight = current + 'px';
                    insertStep();
                }, 800);
            };
            
            animate();
        }
        
        // çº¿æ€§æŸ¥æ‰¾åŠ¨ç”?
        function animateLinearSearch() {
            const bars = document.querySelectorAll('.array-bar');
            const target = parseInt(bars[3].innerHTML); // æŸ¥æ‰¾ç¬?ä¸ªå…ƒç´?
            let i = 0;
            
            const animate = () => {
                if (i >= bars.length) {
                    updateDetectiveMessage('çº¿æ€§æŸ¥æ‰¾å®Œæˆï¼æœªæ‰¾åˆ°ç›®æ ‡å€¼ï¼â?);
                    return;
                }
                
                bars[i].style.backgroundColor = '#f59e0b';
                setTimeout(() => {
                    if (parseInt(bars[i].innerHTML) === target) {
                        bars[i].style.backgroundColor = '#10b981';
                        updateDetectiveMessage(`çº¿æ€§æŸ¥æ‰¾æˆåŠŸï¼åœ¨ä½ç½?{i}æ‰¾åˆ°ç›®æ ‡å€?{target}ï¼âœ…`);
                        return;
                    } else {
                        bars[i].style.backgroundColor = '#ef4444';
                        setTimeout(() => {
                            bars[i].style.backgroundColor = '#3b82f6';
                            i++;
                            setTimeout(animate, 500);
                        }, 400);
                    }
                }, 800);
            };
            
            updateDetectiveMessage(`å¼€å§‹çº¿æ€§æŸ¥æ‰¾ï¼Œç›®æ ‡å€¼ï¼š${target}`);
            animate();
        }
        
        // å¿«é€Ÿæ’åºåŠ¨ç”»ï¼ˆç®€åŒ–ç‰ˆï¼?
        function animateQuickSort() {
            const bars = document.querySelectorAll('.array-bar');
            
            const partition = (arr, low, high) => {
                return new Promise(resolve => {
                    const pivot = parseInt(arr[high].innerHTML);
                    arr[high].style.backgroundColor = '#f59e0b'; // åŸºå‡†å…ƒç´ 
                    
                    let i = low - 1;
                    let j = low;
                    
                    const partitionStep = () => {
                        if (j >= high) {
                            // äº¤æ¢åŸºå‡†å…ƒç´ åˆ°æ­£ç¡®ä½ç½?
                            setTimeout(() => {
                                if (i + 1 !== high) {
                                    const temp = arr[i + 1].innerHTML;
                                    const tempHeight = arr[i + 1].style.height;
                                    arr[i + 1].innerHTML = arr[high].innerHTML;
                                    arr[i + 1].style.height = arr[high].style.height;
                                    arr[i + 1].style.lineHeight = arr[high].style.height;
                                    arr[high].innerHTML = temp;
                                    arr[high].style.height = tempHeight;
                                    arr[high].style.lineHeight = tempHeight;
                                }
                                arr[i + 1].style.backgroundColor = '#10b981';
                                arr[high].style.backgroundColor = '#3b82f6';
                                resolve(i + 1);
                            }, 800);
                            return;
                        }
                        
                        arr[j].style.backgroundColor = '#8b5cf6';
                        setTimeout(() => {
                            if (parseInt(arr[j].innerHTML) < pivot) {
                                i++;
                                if (i !== j) {
                                    const temp = arr[i].innerHTML;
                                    const tempHeight = arr[i].style.height;
                                    arr[i].innerHTML = arr[j].innerHTML;
                                    arr[i].style.height = arr[j].style.height;
                                    arr[i].style.lineHeight = arr[j].style.height;
                                    arr[j].innerHTML = temp;
                                    arr[j].style.height = tempHeight;
                                    arr[j].style.lineHeight = tempHeight;
                                }
                            }
                            arr[j].style.backgroundColor = '#3b82f6';
                            j++;
                            setTimeout(partitionStep, 600);
                        }, 600);
                    };
                    
                    partitionStep();
                });
            };
            
            const quickSort = async (arr, low, high) => {
                if (low < high) {
                    const pi = await partition(arr, low, high);
                    await quickSort(arr, low, pi - 1);
                    await quickSort(arr, pi + 1, high);
                }
            };
            
            quickSort(Array.from(bars), 0, bars.length - 1).then(() => {
                updateDetectiveMessage('å¿«é€Ÿæ’åºå®Œæˆï¼åˆ†æ²»ç­–ç•¥çš„å¨åŠ›ï¼âš?);
                bars.forEach(bar => bar.style.backgroundColor = '#10b981');
            });
        }
        
        // å½’å¹¶æ’åºåŠ¨ç”»ï¼ˆç®€åŒ–ç‰ˆï¼?
        function animateMergeSort() {
            const bars = document.querySelectorAll('.array-bar');
            updateDetectiveMessage('å½’å¹¶æ’åºæ¼”ç¤ºï¼šåˆ†è€Œæ²»ä¹‹ï¼');
            
            // ç®€åŒ–çš„å½’å¹¶æ’åºå¯è§†åŒ?
            let step = 0;
            const steps = [
                () => {
                    bars.forEach((bar, i) => {
                        bar.style.backgroundColor = i < bars.length/2 ? '#ef4444' : '#3b82f6';
                    });
                },
                () => {
                    bars.forEach((bar, i) => {
                        bar.style.backgroundColor = i < bars.length/4 || (i >= bars.length/2 && i < 3*bars.length/4) ? '#f59e0b' : '#8b5cf6';
                    });
                },
                () => {
                    bars.forEach(bar => bar.style.backgroundColor = '#10b981');
                    updateDetectiveMessage('å½’å¹¶æ’åºå®Œæˆï¼é€’å½’åˆ†è§£å†åˆå¹¶ï¼ğŸ”„');
                }
            ];
            
            const animate = () => {
                if (step < steps.length) {
                    steps[step]();
                    step++;
                    setTimeout(animate, 1500);
                }
            };
            
            animate();
        }
        
        // é˜¶ä¹˜åŠ¨ç”»
        function animateFactorial() {
            const viz = document.getElementById('algorithm-visualization');
            viz.innerHTML = '<div id="factorial-demo" class="text-center"></div>';
            
            const demo = document.getElementById('factorial-demo');
            const n = 5;
            let current = n;
            let result = 1;
            
            const animate = () => {
                if (current === 0) {
                    demo.innerHTML += `<div class="text-green-400 text-xl mt-4">ç»“æœï¼?{n}! = ${result}</div>`;
                    updateDetectiveMessage('é˜¶ä¹˜è®¡ç®—å®Œæˆï¼é€’å½’çš„åŠ›é‡ï¼ğŸ’ª');
                    return;
                }
                
                demo.innerHTML += `<div class="text-blue-400 mb-2">${current}! = ${current} Ã— ${current-1}!</div>`;
                result *= current;
                current--;
                setTimeout(animate, 1000);
            };
            
            demo.innerHTML = `<div class="text-yellow-400 text-lg mb-4">è®¡ç®— ${n}! çš„è¿‡ç¨‹ï¼š</div>`;
            animate();
        }
        
        // èƒŒåŒ…é—®é¢˜åŠ¨ç”»
        function animateKnapsack() {
            const viz = document.getElementById('algorithm-visualization');
            viz.innerHTML = `
                <div class="text-center">
                    <div class="text-yellow-400 text-lg mb-4">0-1èƒŒåŒ…é—®é¢˜æ¼”ç¤º</div>
                    <div class="grid grid-cols-4 gap-2 mb-4">
                        <div class="bg-blue-600 p-2 rounded">ç‰©å“1: v=60, w=10</div>
                        <div class="bg-blue-600 p-2 rounded">ç‰©å“2: v=100, w=20</div>
                        <div class="bg-blue-600 p-2 rounded">ç‰©å“3: v=120, w=30</div>
                        <div class="bg-gray-600 p-2 rounded">å®¹é‡: 50</div>
                    </div>
                    <div id="knapsack-steps"></div>
                </div>
            `;
            
            const steps = document.getElementById('knapsack-steps');
            const messages = [
                'æ­¥éª¤1: åˆå§‹åŒ–DPè¡¨æ ¼...',
                'æ­¥éª¤2: è€ƒè™‘ç‰©å“1 (v=60, w=10)...',
                'æ­¥éª¤3: è€ƒè™‘ç‰©å“2 (v=100, w=20)...',
                'æ­¥éª¤4: è€ƒè™‘ç‰©å“3 (v=120, w=30)...',
                'æœ€ä¼˜è§£: é€‰æ‹©ç‰©å“2å’Œç‰©å“?ï¼Œæ€»ä»·å€?220'
            ];
            
            let step = 0;
            const animate = () => {
                if (step < messages.length) {
                    steps.innerHTML += `<div class="text-green-400 mb-2">${messages[step]}</div>`;
                    step++;
                    setTimeout(animate, 1200);
                } else {
                    updateDetectiveMessage('èƒŒåŒ…é—®é¢˜æ±‚è§£å®Œæˆï¼åŠ¨æ€è§„åˆ’çš„åº”ç”¨ï¼ğŸ?);
                }
            };
            
            animate();
        }
        
        // æœ€é•¿é€’å¢å­åºåˆ—åŠ¨ç”?
        function animateLIS() {
            const viz = document.getElementById('algorithm-visualization');
            const sequence = [10, 9, 2, 5, 3, 7, 101, 18];
            
            viz.innerHTML = `
                <div class="text-center">
                    <div class="text-yellow-400 text-lg mb-4">æœ€é•¿é€’å¢å­åºåˆ?(LIS)</div>
                    <div class="flex justify-center mb-4">
                        ${sequence.map((num, i) => `<div id="lis-${i}" class="w-12 h-12 bg-blue-600 text-white flex items-center justify-center mx-1 rounded">${num}</div>`).join('')}
                    </div>
                    <div id="lis-info" class="text-green-400"></div>
                </div>
            `;
            
            const info = document.getElementById('lis-info');
            const lis = [2, 3, 7, 18]; // ä¸€ä¸ªå¯èƒ½çš„LIS
            let step = 0;
            
            const animate = () => {
                if (step < lis.length) {
                    const index = sequence.indexOf(lis[step]);
                    document.getElementById(`lis-${index}`).style.backgroundColor = '#10b981';
                    info.innerHTML = `æ‰¾åˆ°é€’å¢å…ƒç´ : ${lis.slice(0, step + 1).join(' â†?')}`;
                    step++;
                    setTimeout(animate, 1000);
                } else {
                    info.innerHTML = `æœ€é•¿é€’å¢å­åºåˆ? [${lis.join(', ')}]ï¼Œé•¿åº? ${lis.length}`;
                    updateDetectiveMessage('LISè®¡ç®—å®Œæˆï¼åŠ¨æ€è§„åˆ’è§£å†³å­åºåˆ—é—®é¢˜ï¼ğŸ“?);
                }
            };
            
            animate();
        }

        function showSimulatedAnimation(algorithm) {
            const viz = document.getElementById('algorithm-visualization');
            const originalContent = viz.innerHTML;
            
            viz.innerHTML = `
                <div class="text-center py-8">
                    <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-500 mx-auto mb-4"></div>
                    <p class="text-gray-600">æ­£åœ¨æ¼”ç¤º${algorithm}ç®—æ³•...</p>
                </div>
            `;
            
            setTimeout(() => {
                viz.innerHTML = originalContent;
                updateDetectiveMessage(`${algorithm}ç®—æ³•æ¼”ç¤ºå®Œæˆï¼ç†è§£ç®—æ³•åŸç†æ˜¯å…³é”®ï¼ğŸ’¡`);
            }, 3000);
        }

        // ç”Ÿæˆä»£ç å?
        function generateCodeBlocks() {
            const container = document.getElementById('code-blocks');
            const blocks = [
                { text: '#include <iostream>', type: 'header' },
                { text: 'using namespace std;', type: 'namespace' },
                { text: 'int main() {', type: 'function' },
                { text: 'cout << "Hello" << endl;', type: 'statement' },
                { text: 'return 0;', type: 'return' },
                { text: '}', type: 'bracket' }
            ];
            
            container.innerHTML = blocks.map(block => 
                `<div class="code-block p-2 bg-blue-100 rounded cursor-move text-sm code-font" draggable="true">
                    ${block.text}
                </div>`
            ).join('');
        }

        // å¼€å§‹æµ‹è¯?
        function startTest() {
            const testArea = document.getElementById('test-area');
            gameState.currentTest = {
                questions: examQuestions.slice(0, 10), // éšæœºé€‰æ‹©10é“é¢˜
                currentQuestion: 0,
                score: 0,
                startTime: Date.now(),
                timeLeft: 15 * 60 // 15åˆ†é’Ÿ
            };
            
            showCurrentQuestion();
            startTimer();
            updateDetectiveMessage('æµ‹è¯•å¼€å§‹ï¼è®¤çœŸç­”é¢˜ï¼Œç›¸ä¿¡ä½ ä¸€å®šèƒ½å–å¾—å¥½æˆç»©ï¼ğŸ’ª');
        }

        // æ˜¾ç¤ºå½“å‰é—®é¢˜
        function showCurrentQuestion() {
            if (!gameState.currentTest) return;
            
            const test = gameState.currentTest;
            const question = test.questions[test.currentQuestion];
            const testArea = document.getElementById('test-area');
            
            testArea.innerHTML = `
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-sm text-gray-500">ç¬?${test.currentQuestion + 1} é¢?/ å…?${test.questions.length} é¢?/span>
                        <span class="text-sm text-blue-600">${question.year} ${question.type}</span>
                    </div>
                    <h4 class="text-lg font-semibold mb-4">${question.question}</h4>
                    <div class="space-y-2">
                        ${question.options.map((option, index) => `
                            <div class="quiz-option p-3 border rounded-md cursor-pointer" onclick="selectAnswer(${index})">
                                ${option}
                            </div>
                        `).join('')}
                    </div>
                    <div class="mt-6 flex justify-between">
                        <button onclick="previousQuestion()" ${test.currentQuestion === 0 ? 'disabled' : ''} 
                                class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 disabled:opacity-50">
                            ä¸Šä¸€é¢?
                        </button>
                        <button onclick="nextQuestion()" 
                                class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">
                            ${test.currentQuestion === test.questions.length - 1 ? 'æäº¤ç­”æ¡ˆ' : 'ä¸‹ä¸€é¢?}
                        </button>
                    </div>
                </div>
            `;
        }

        // é€‰æ‹©ç­”æ¡ˆ
        function selectAnswer(answerIndex) {
            if (!gameState.currentTest) return;
            
            const question = gameState.currentTest.questions[gameState.currentTest.currentQuestion];
            question.userAnswer = answerIndex;
            
            // æ›´æ–°UIæ˜¾ç¤ºé€‰ä¸­çŠ¶æ€?
            document.querySelectorAll('.quiz-option').forEach((option, index) => {
                option.classList.remove('quiz-correct', 'quiz-incorrect');
                if (index === answerIndex) {
                    option.classList.add('border-blue-500', 'bg-blue-50');
                } else {
                    option.classList.remove('border-blue-500', 'bg-blue-50');
                }
            });
        }

        // ä¸‹ä¸€é¢?
        function nextQuestion() {
            if (!gameState.currentTest) return;
            
            const test = gameState.currentTest;
            if (test.currentQuestion < test.questions.length - 1) {
                test.currentQuestion++;
                showCurrentQuestion();
            } else {
                finishTest();
            }
        }

        // ä¸Šä¸€é¢?
        function previousQuestion() {
            if (!gameState.currentTest) return;
            
            const test = gameState.currentTest;
            if (test.currentQuestion > 0) {
                test.currentQuestion--;
                showCurrentQuestion();
            }
        }

        // å®Œæˆæµ‹è¯•
        function finishTest() {
            if (!gameState.currentTest) return;
            
            const test = gameState.currentTest;
            let score = 0;
            
            // è®¡ç®—åˆ†æ•°
            test.questions.forEach(question => {
                if (question.userAnswer === question.answer) {
                    score++;
                }
            });
            
            // æ›´æ–°ç»Ÿè®¡
            gameState.progress.totalAnswers += test.questions.length;
            gameState.progress.correctAnswers += score;
            
            // æ˜¾ç¤ºç»“æœ
            const testArea = document.getElementById('test-area');
            testArea.innerHTML = `
                <div class="text-center">
                    <h3 class="text-2xl font-bold text-green-600 mb-4">æµ‹è¯•å®Œæˆï¼?/h3>
                    <div class="text-6xl mb-4">${score >= 8 ? 'ğŸ‰' : score >= 6 ? 'ğŸ˜Š' : 'ğŸ˜'}</div>
                    <p class="text-xl mb-4">å¾—åˆ†ï¼?{score} / ${test.questions.length}</p>
                    <p class="text-lg text-gray-600 mb-6">æ­£ç¡®ç‡ï¼š${Math.round(score / test.questions.length * 100)}%</p>
                    <button onclick="reviewAnswers()" class="bg-blue-500 text-white px-6 py-3 rounded-md hover:bg-blue-600 mr-4">
                        æŸ¥çœ‹ç­”æ¡ˆè§£æ
                    </button>
                    <button onclick="startTest()" class="bg-green-500 text-white px-6 py-3 rounded-md hover:bg-green-600">
                        é‡æ–°æµ‹è¯•
                    </button>
                </div>
            `;
            
            updateProgress();
            updateDetectiveMessage(`æµ‹è¯•å®Œæˆï¼å¾—åˆ?${score}/${test.questions.length}ï¼?{score >= 8 ? 'è¡¨ç°ä¼˜ç§€' : 'ç»§ç»­åŠ æ²¹'}ï¼ğŸ¯`);
        }

        // æŸ¥çœ‹ç­”æ¡ˆè§£æ
        function reviewAnswers() {
            if (!gameState.currentTest) return;
            
            const test = gameState.currentTest;
            const testArea = document.getElementById('test-area');
            
            testArea.innerHTML = `
                <h3 class="text-xl font-bold mb-4">ç­”æ¡ˆè§£æ</h3>
                <div class="space-y-6">
                    ${test.questions.map((question, index) => {
                        const isCorrect = question.userAnswer === question.answer;
                        return `
                            <div class="border rounded-lg p-4 ${isCorrect ? 'border-green-200 bg-green-50' : 'border-red-200 bg-red-50'}">
                                <div class="flex items-center mb-2">
                                    <span class="font-bold">ç¬?{index + 1}é¢?/span>
                                    <span class="ml-2 px-2 py-1 rounded text-sm ${isCorrect ? 'bg-green-200 text-green-800' : 'bg-red-200 text-red-800'}">
                                        ${isCorrect ? 'âœ?æ­£ç¡®' : 'âœ?é”™è¯¯'}
                                    </span>
                                </div>
                                <p class="mb-3">${question.question}</p>
                                <p class="mb-2"><strong>æ­£ç¡®ç­”æ¡ˆï¼?/strong>${question.options[question.answer]}</p>
                                ${question.userAnswer !== undefined ? `<p class="mb-2"><strong>ä½ çš„ç­”æ¡ˆï¼?/strong>${question.options[question.userAnswer]}</p>` : ''}
                                <p class="text-sm text-gray-600"><strong>è§£æï¼?/strong>${question.explanation}</p>
                            </div>
                        `;
                    }).join('')}
                </div>
                <div class="text-center mt-6">
                    <button onclick="startTest()" class="bg-blue-500 text-white px-6 py-3 rounded-md hover:bg-blue-600">
                        å†æ¬¡æµ‹è¯•
                    </button>
                </div>
            `;
        }

        // å¼€å§‹è®¡æ—¶å™¨
        function startTimer() {
            if (!gameState.currentTest) return;
            
            const timer = setInterval(() => {
                if (!gameState.currentTest) {
                    clearInterval(timer);
                    return;
                }
                
                gameState.currentTest.timeLeft--;
                updateTimerDisplay();
                
                if (gameState.currentTest.timeLeft <= 0) {
                    clearInterval(timer);
                    finishTest();
                }
            }, 1000);
        }

        // æ›´æ–°è®¡æ—¶å™¨æ˜¾ç¤?
        function updateTimerDisplay() {
            if (!gameState.currentTest) return;
            
            const minutes = Math.floor(gameState.currentTest.timeLeft / 60);
            const seconds = gameState.currentTest.timeLeft % 60;
            const display = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            document.getElementById('test-timer').textContent = display;
            
            // æ—¶é—´ä¸è¶³æ—¶æ”¹å˜é¢œè‰?
            if (gameState.currentTest.timeLeft <= 300) { // 5åˆ†é’Ÿ
                document.getElementById('test-timer').className = 'text-2xl font-bold text-red-600';
            }
        }

        // æ›´æ–°ä¾¦æ¢æ¶ˆæ¯
        function updateDetectiveMessage(message) {
            document.getElementById('detective-message').textContent = message;
        }

        // æ›´æ–°è¿›åº¦
        function updateProgress() {
            const masteredCount = gameState.progress.masteredTopics.size;
            const totalTopics = Object.keys(knowledgeData).length;
            const overallProgress = Math.round((masteredCount / totalTopics) * 100);
            
            document.getElementById('overall-progress').textContent = overallProgress + '%';
            document.getElementById('mastered-count').textContent = masteredCount;
            document.getElementById('practice-count').textContent = gameState.progress.completedPractices;
            
            const accuracy = gameState.progress.totalAnswers > 0 ? 
                Math.round((gameState.progress.correctAnswers / gameState.progress.totalAnswers) * 100) : 0;
            document.getElementById('accuracy-rate').textContent = accuracy + '%';
        }

        // æ›´æ–°å­¦ä¹ æ—¶é•¿
        function updateStudyTime() {
            const studyTimeMinutes = Math.floor((Date.now() - gameState.progress.studyStartTime) / 60000);
            document.getElementById('study-time').textContent = studyTimeMinutes;
        }

        // ä¿å­˜è¿›åº¦
        function saveProgress() {
            const progressData = {
                masteredTopics: Array.from(gameState.progress.masteredTopics),
                completedPractices: gameState.progress.completedPractices,
                correctAnswers: gameState.progress.correctAnswers,
                totalAnswers: gameState.progress.totalAnswers,
                studyStartTime: gameState.progress.studyStartTime
            };
            localStorage.setItem('cspj-progress', JSON.stringify(progressData));
        }

        // åŠ è½½è¿›åº¦
        function loadProgress() {
            const saved = localStorage.getItem('cspj-progress');
            if (saved) {
                const progressData = JSON.parse(saved);
                gameState.progress.masteredTopics = new Set(progressData.masteredTopics || []);
                gameState.progress.completedPractices = progressData.completedPractices || 0;
                gameState.progress.correctAnswers = progressData.correctAnswers || 0;
                gameState.progress.totalAnswers = progressData.totalAnswers || 0;
                gameState.progress.studyStartTime = progressData.studyStartTime || Date.now();
            }
            updateProgress();
        }

        // æš´éœ²å…¨å±€å‡½æ•°
        window.switchTab = switchTab;
        window.showKnowledgeTopic = showKnowledgeTopic;
        window.markTopicCompleted = markTopicCompleted;
        window.loadCodeTemplate = loadCodeTemplate;
        window.runCode = runCode;
        window.clearCode = clearCode;
        window.showAlgorithmViz = showAlgorithmViz;
        window.startVisualization = startVisualization;
        window.startTest = startTest;
        window.selectAnswer = selectAnswer;
        window.nextQuestion = nextQuestion;
        window.previousQuestion = previousQuestion;
        window.reviewAnswers = reviewAnswers;

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
